@page "/suggestions-edit"
@using NS.WEB.Modules.Country.Core

@inherits PageCore<SuggestionsPage>

@inject SuggestionsApi SuggestionsApi

<MudDataGrid @ref="_elementGrid" T="SuggestionCountry" Items="@_elements" Bordered="true" Dense="true" CommittedItemChanges="@CommittedItemChanges" ReadOnly="false">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Suggestions</MudText>
        <MudSpacer />
        <MudSelect T="string" Value="@category" ValueChanged="CategoryChanged" FitContent="true" Class="me-2">
            <MudSelectItem Value="@("adventure")">adventure</MudSelectItem>
            <MudSelectItem Value="@("relaxing")">relaxing</MudSelectItem>
            <MudSelectItem Value="@("cultural")">cultural</MudSelectItem>
            <MudSelectItem Value="@("luxury")">luxury</MudSelectItem>
            <MudSelectItem Value="@("landscape")">landscape</MudSelectItem>
        </MudSelect>
        <MudButton OnClick="NewItemAsync" Variant="Variant.Filled" Class="me-2" Disabled="@(category.Empty())">
            Add New Item
        </MudButton>
        <MudButton OnClick="SaveAsync" Variant="Variant.Filled" Disabled="@(category.Empty() || _elements.Empty())">
            Save All
        </MudButton>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.Index" Editable="false" />
        <PropertyColumn Property="x => x.Country" Title="Country">
            <CellTemplate>
                @context.Item.Country.GetCustomCountryAttribute()?.Name
            </CellTemplate>
            <EditTemplate>
                <MudSelect @bind-Value="context.Item.Country" Required RequiredError="You must select a Position!!!" Margin="@Margin.Dense">
                    @foreach (var item in EnumHelper.GetArray<NS.Shared.Enums.Country>().OrderBy(prop => prop.GetCustomCountryAttribute()?.Name))
                    {
                        <MudSelectItem Value="@item">@item.GetCustomCountryAttribute()?.Name</MudSelectItem>
                    }
                </MudSelect>
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Title" Required="false" />
        <PropertyColumn Property="x => x.Description" Required="false" />
        <TemplateColumn CellClass="d-flex justify-between">
            <CellTemplate>
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItem(context.Item))" />
            </CellTemplate>
            <EditTemplate>
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItem(context.Item))" />
            </EditTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    private List<SuggestionCountry> _elements = [];
    private MudDataGrid<SuggestionCountry> _elementGrid = default!;

    private Suggestion? Suggestion;
    private string? category;

    private async Task CategoryChanged(string value)
    {
        try
        {
            category = value;
            Suggestion = await SuggestionsApi.SuggestionGet(category);
            Suggestion ??= new Suggestion();
            _elements = Suggestion?.Countries ?? [];
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }

    private async Task NewItemAsync()
    {
        try
        {
            var elem = new SuggestionCountry();
            await _elementGrid.SetEditingItemAsync(elem);
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }

    private void DeleteItem(SuggestionCountry item)
    {
        _elements.Remove(item);
    }

    private void CommittedItemChanges(SuggestionCountry item)
    {
        if (item.Index == 0) // new item
        {
            var maxMaster = _elements.Any() ? _elements.Max(x => x.Index) : 0;
            var maxElements = _elements.Any() ? _elements.Max(x => x.Index) : 0;
            item.Index = maxElements + 1;

            _elements.Add(item);
        }
    }

    private async Task SaveAsync()
    {
        try
        {
            if (Suggestion == null) return;

            Suggestion.Initialize(category!);
            Suggestion.Countries = _elements;

            Suggestion = await SuggestionsApi.SuggestionPost(Suggestion);
            _elements = Suggestion?.Countries ?? [];
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }
}