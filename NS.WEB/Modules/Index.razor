@page "/"
@page "/index"
@using NS.WEB.Modules.Country.Core
@using NS.WEB.Modules.Subscription.Core

@inherits PageCore<Index>
@inject IpInfoApi IpInfoApi

<SeoHeader Title="@SeoTranslations.AppSubtitle" Description="@SeoTranslations.AppDescription" Url="/" Keywords="@(["country"])"></SeoHeader>
<PageHeader Image="icon/icon-71.png" Title="@SeoTranslations.AppName" Subtitle="@SeoTranslations.AppSubtitle" Description="@SeoTranslations.AppDescription">
    <ActionFragment>
        @if (SubscriptionAllowed)
        {
            <MudTooltip Text="@Modules.Profile.Resources.Translations.Subscription">
                <MudFab Color="Color.Primary" StartIcon="@IconsFA.Solid.Icon("gem").WithAnimation(IconAnimation.Fade).Font" IconColor="Color.Warning" Size="AppStateStatic.Size"
                        OnClick="@OpenSubscription" Disabled="true" />
            </MudTooltip>
        }
    </ActionFragment>
</PageHeader>

@* <GoogleAdSense Section="@GoogleAdSense.AdUnit.Index" IsAuthenticated="IsAuthenticated"></GoogleAdSense> *@

<PageSection Title="Countries" ButtonAction="false">
    <ActionFragment>
        <MudSelect Value="region" ValueChanged="@((string? vl) => { region = vl; subregion = null; StateHasChanged(); })" Label="Region" FitContent="!IsMobile" Clearable="true" Dense="true"
                   Class="me-2" Variant="Variant.Text">
            @foreach (var item in Countries.GetRegions())
            {
                <MudSelectItem Value="item">@item</MudSelectItem>
            }
        </MudSelect>
        <MudSelect Value="subregion" ValueChanged="@((string? vl) => { subregion = vl; StateHasChanged(); })" Label="Subregion" FitContent="!IsMobile" Clearable="true" Dense="true"
                   Class="ms-2" Variant="Variant.Text" Disabled="Countries.GetSubRegions(region).Empty()">
            @foreach (var item in Countries.GetSubRegions(region))
            {
                <MudSelectItem Value="item">@item</MudSelectItem>
            }
        </MudSelect>
    </ActionFragment>
    <BodyFragment>
        <MudGrid Spacing="4">
            @foreach (var item in Countries.GetCountries(region, subregion))
            {
                <MudItem xs="6" sm="3" md="2" xl="1" Style="text-align: center;">
                    <MudPaper Class="pa-2">
                        <MudLink Href="@($"country/{item.Value.ToString().ToLower()}")">
                            <MudImage Src="@item.Flag" Height="64"></MudImage>
                            <MudText>@item.Name</MudText>
                        </MudLink>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </BodyFragment>
</PageSection>

@code {

    private List<EnumObjectCountry<NS.Shared.Enums.Country>> Countries { get; set; } = [];

    private string? region;
    private string? subregion;

    private bool IsMobile => Breakpoint <= Breakpoint.Xs;

    private bool SubscriptionAllowed { get; set; } = true;

    private readonly Dictionary<string, string> _iosAllowedCountries = new()
    {
        { "US", "United States" }
    };

    protected override void OnInitialized()
    {
        Countries = EnumHelper.GetListCountry<NS.Shared.Enums.Country>();

        base.OnInitialized();
    }

    private async Task OpenSubscription()
    {
        await DialogService.SubscriptionPopup(IsAuthenticated);
    }

}
