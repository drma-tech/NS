@using NS.Shared.Models.News
@using NS.WEB.Modules.Country.Resources
@inherits ComponentCore<TopicNewsComponent>

@inject CacheNewsApi CacheNewsApi

<NewPageSection Title="@($"{Translations.NewsTitle}")" Description="@Translations.NewsDescriptionShort" Icon="@IconsFA.Solid.Icon("newspaper").Font">
    <BodyFragment>
        <MudTabs KeepPanelsAlive="true" MinimumTabWidth="100" ApplyEffectsToContainer="true" PanelClass="@Css.Build().Small("pt")"
                 ActivePanelIndexChanged="@(async (int vl) => { index = vl; await LoadNonEssentialDataAsync(); })">
            <Header>
                <MudTooltip Text="Expand">
                    <MudIconButton Icon="@IconsFA.Solid.Icon("expand").Font" Href="@($"/news/...")" Disabled="true" />
                </MudTooltip>
            </Header>
            <ChildContent>
                <MudTabPanel Text="travel">
                </MudTabPanel>
                <MudTabPanel Text="tourism">
                </MudTabPanel>
            </ChildContent>
        </MudTabs>
        <NewRenderControl Actions="Actions" Instance="News" ExpressionEmpty="@((CacheDocument<NewsModel>? obj) => obj?.Data == null || obj.Data.Items.Empty())" LoadingHeight="350px">
            <div id="@_gallerySwiperId" class="swiper">
                <div class="swiper-wrapper">
                    @foreach (var item in News?.Data?.Items ?? [])
                    {
                        <div class="swiper-slide" style="height: auto !important;">
                            <MudLink Href="@item.link" Target="_blank" rel="noindex, nofollow">
                                <MudImage Src="@item.url_img" Alt="@item.title" FallbackSrc="images/no-image.png" Class="d-block" Style="width: 100%; max-height: 350px;" ObjectFit="ObjectFit.Cover"></MudImage>
                                <MudChip T="string" Label="true" Color="Color.Secondary" Class="poster-chip" Style="top: 0; left: 0; position: absolute; opacity: 0.75;" Size="AppStateStatic.Size">
                                    @item.date.Humanize()
                                </MudChip>
                                <MudText Typo="Typo.caption" Class="carousel-caption d-none d-md-block p-1">
                                    <p>@((MarkupString)item.title!)</p>
                                </MudText>
                            </MudLink>
                        </div>
                    }
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
                @* <div class="swiper-pagination"></div> *@
                <div class="autoplay-progress">
                    <svg viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="20"></circle>
                    </svg>
                    <span></span>
                </div>
            </div>
        </NewRenderControl>
    </BodyFragment>
</NewPageSection>

@code {
    public ComponentActions<CacheDocument<NewsModel>?> Actions { get; set; } = new();
    private CacheDocument<NewsModel>? News { get; set; }

    private readonly string _gallerySwiperId = $"swiper-{Guid.NewGuid()}";

    private int index;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            await base.OnAfterRenderAsync(firstRender);

            await JsRuntime.Swiper().InitNews(_gallerySwiperId);
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }

    protected override async Task LoadNonEssentialDataAsync()
    {
        Actions.StartLoading?.Invoke(null);
        News = await CacheNewsApi.GetNewsTopic(index == 0 ? "travel" : "tourism", "compact");
        Actions.FinishLoading?.Invoke(News);
    }

}