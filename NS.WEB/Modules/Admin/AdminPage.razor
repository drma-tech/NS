@page "/admin"
@using System.Text.Json
@using NS.WEB.Modules.Country.Core
@attribute [Authorize(Roles = "administrator")]

@inherits PageCore<AdminPage>

@inject CountriesApi CountriesApi
@inject ScrapApi ScrapApi
@inject IJSRuntime JS

<SeoHeader Title="admin" Description="admin" Url="/admin" Index="false" Keywords="@([])"></SeoHeader>

<MudButton OnClick="@SaveSession" Color="Color.Primary" Variant="Variant.Filled" Class="mb-4">
    Save Session
</MudButton>

<MudSelect @bind-Value="Field" Label="Field" FullWidth="true" Clearable="true" Class="mb-4">
    @foreach (var item in EnumHelper.GetArray<Field>())
    {
        <MudSelectItem Value="item">@item</MudSelectItem>
    }
</MudSelect>

<MudButton OnClick="@ScrapData" Color="Color.Primary" Variant="Variant.Filled">
    Import Data
</MudButton>

@code {
    private List<EnumObjectCountry<NS.Shared.Enums.Country>> Countries { get; set; } = [];
    public Field Field { get; set; } = EnumHelper.GetArray<Field>().Last();

    protected override async Task LoadEssentialDataAsync()
    {
        Countries = EnumHelper.GetListCountry<NS.Shared.Enums.Country>();
    }

    protected async Task SaveSession()
    {
        if (Countries != null)
        {
            await JS.InvokeVoidAsync("window.localStorage.setItem",
                new object[] { "AllCountries", JsonSerializer.Serialize(Countries, new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) });
        }
    }

    protected async Task ScrapData()
    {
        try
        {
            if (Countries != null)
            {
                await ScrapApi.ScrapPopulation(Field);

                Snackbar.Add("Scrap Finished", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            ex.ProcessException(Snackbar, Logger);
        }
    }
}
