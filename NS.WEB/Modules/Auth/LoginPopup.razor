@using NS.WEB.Core.Auth
@using NS.WEB.Modules.Auth.Resources
@using NS.WEB.Modules.Subscription.Core
@inherits ComponentCore<LoginPopup>

<MudDialog Style="width: 100%">
    <DialogContent>
        <MudStack Spacing="@Css.SpaceSmall">
            <MudButton Variant="Variant.Filled" OnClick="LoginWithGoogle" StartIcon="@IconsFA.Brands.Icon("google").Font" Disabled="_processing">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Continue with Google</MudText>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" OnClick="LoginWithApple" StartIcon="@IconsFA.Brands.Icon("apple").Font" Disabled="true || _processing">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Continue with Apple</MudText>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" OnClick="LoginWithMicrosoft" StartIcon="@IconsFA.Brands.Icon("microsoft").Font" Disabled="true || _processing">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Continue with Microsoft</MudText>
                }
            </MudButton>
        </MudStack>
        <div style="text-align: center;">
            <MudText Class="@Css.Build().Medium("mt").Small("mx")">
                @((MarkupString)string.Format(Translations.Terms1, $"<a href='support/terms' target='_blank' class='mud-link mud-primary-text mud-link-underline-hover'>{NS.WEB.Modules.Support.Resources.Translations.TermsUse}</a>", $"<a href='support/privacy' target='_blank' class='mud-link mud-primary-text mud-link-underline-hover'>{NS.WEB.Modules.Support.Resources.Translations.PrivacyPolicy}</a>"))
            </MudText>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => { MudDialog?.Close(); })">
            @Button.Close
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    private void CloseDialog() => MudDialog?.Close();

    private async Task LoginWithGoogle() => await SignIn("google");
    private async Task LoginWithApple() => await SignIn("apple");
    private async Task LoginWithMicrosoft() => await SignIn("microsoft");
    private async Task LoginWithX() => await SignIn("x");
    private async Task LoginWithYahoo() => await SignIn("yahoo");
    private async Task LoginWithEmail(string? email) => await SignIn("email", email);

    private NS.Shared.Enums.Platform? Platform { get; set; }
    private bool _processing = false;

    protected override async Task ProcessPopupData()
    {
        Platform = await AppStateStatic.GetPlatform(JsRuntime);
    }

    private async Task SignIn(string? provider = null, string? email = null)
    {
        try
        {
            _processing = true;

            CloseDialog();
            await JsRuntime.Utils().SetStorage<AuthProvider>("auth", AuthProvider.Firebase);
            await JsRuntime.Firebase().SignInAsync(provider!);
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
            _processing = false; StateHasChanged();
        }
        finally
        {
            await Task.Delay(10000);
            _processing = false;
        }
    }

}
