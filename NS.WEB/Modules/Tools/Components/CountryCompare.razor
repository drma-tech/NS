@using NS.Shared.Models.Country
@using NS.WEB.Modules.Country.Core
@using NS.Shared.Core.Helper

@inherits ComponentCore<CountryCompare>

@inject AllRegionsApi AllRegionsApi
@inject RegionsApi RegionsApi

<SeoHeader Title="Compare" Description="..." Url="/compare" Keywords="@(["country compare"])" Index="false"></SeoHeader>

<NewPageSection Title="Compare regions" ShowHeader="false">
    <ActionsFragment>
        <MudToolBar WrapContent="true" Gutters="false" Dense="true" Style="min-height: auto;">
            <MudSelect Class="me-1" Value="@continent" ValueChanged="@((string? vl) => { continent = vl; StateHasChanged(); })" Label="Continent" FitContent="true" Dense="true" Variant="Variant.Text">
                @foreach (var item in AllRegions?.GetContinents() ?? [])
                {
                    <MudSelectItem Value="item">@item</MudSelectItem>
                }
            </MudSelect>
            <MudSelect Class="me-2" Value="@_selectedRegion" ValueChanged="@((string? vl) => { _selectedRegion = vl; })" Label="Region" FitContent="true" Dense="true" Variant="Variant.Text" style="width: 200px;">
                @foreach (var item in AllRegions?.GetList(continent, null) ?? [])
                {
                    <MudSelectItem Value="item.code">@item.name</MudSelectItem>
                }
            </MudSelect>
            <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="AddHandle"></MudIconButton>
        </MudToolBar>
    </ActionsFragment>
    <BodyFragment>
        <MudStack Wrap="Wrap.NoWrap" Spacing="4" Row="true" AlignItems="AlignItems.Start">
            <MudPaper Class="pa-2" Style="width: 310px;">
                <MudText Color="Color.Primary" Typo="Typo.subtitle1" Align="Align.Center">Region</MudText>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Society and Government</MudText>

                <ItemData TValue="string" For="@(() => emptyRegion.CorruptionScore)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.HDI)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.DMDemocracyIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.DMClassification)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.EconomistDemocracyIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.EconomistRegimeType)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.FreedomExpressionIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.FreedomScore)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.CensorshipIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.HappinessIndex)" OnlyLabel="true"></ItemData>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Economy</MudText>

                <ItemData TValue="string" For="@(() => emptyRegion.OECD)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.GDP_PPP)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.GDP_Nominal)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.EconomicFreedomIndex)" OnlyLabel="true"></ItemData>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Security and Peace</MudText>

                <ItemData TValue="string" For="@(() => emptyRegion.TsaSafetyIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.NumbeoSafetyIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.GlobalTerrorismIndex)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.GlobalPeaceIndex)" OnlyLabel="true"></ItemData>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Environment and Health</MudText>

                <ItemData TValue="string" For="@(() => emptyRegion.YaleWaterScore)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.NumbeoPollutionIndex)" OnlyLabel="true"></ItemData>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Mobility and Tourism</MudText>

                <ItemData TValue="string" For="@(() => emptyRegion.VisaFree)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.TourismIndex)" OnlyLabel="true"></ItemData>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Guide</MudText>

                <ItemsData TValue="string" For="@(() => emptyRegion.ConflictLevel)" OnlyLabel="true"></ItemsData>
                <ItemsData TValue="string" For="@(() => emptyRegion.ConflictForecast)" OnlyLabel="true"></ItemsData>
                <ItemsData TValue="string" For="@(() => emptyRegion.Risks)" OnlyLabel="true"></ItemsData>
                <ItemsData TValue="string" For="@(() => emptyRegion.TaxiApps)" OnlyLabel="true"></ItemsData>
                <ItemsData TValue="string" For="@(() => emptyRegion.Languages)" OnlyLabel="true"></ItemsData>

                <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Cost of Living</MudText>

                <ItemData TValue="string" For="@(() => emptyRegion.AptCityCenter)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.AptOutsideCenter)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.Meal)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.MarketWestern)" OnlyLabel="true"></ItemData>
                <ItemData TValue="string" For="@(() => emptyRegion.MarketAsian)" OnlyLabel="true"></ItemData>
            </MudPaper>

            <NewRenderControl Actions="Actions" Instance="SelectedRegions" ExpressionEmpty="@((List<RegionData> lst) => lst.Empty())">
                @foreach (var item in context)
                {
                    var _country = AllRegions?.GetByCode(item.Id.ToLower().Split(":")[1]);

                    <MudPaper Class="pa-2" Style="width: 310px;">
                        <MudText Color="Color.Primary" Typo="Typo.subtitle1" Align="Align.Center">@_country?.name</MudText>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Society and Government</MudText>

                        <ItemData For="@(() => item.CorruptionScore)" Value="item.CorruptionScore" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.HDI)" Value="item.HDI" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.DMDemocracyIndex)" Value="item.DMDemocracyIndex" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.DMClassification)" Value="item.DMClassification" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.EconomistDemocracyIndex)" Value="item.EconomistDemocracyIndex" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.EconomistRegimeType)" Value="item.EconomistRegimeType" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.FreedomExpressionIndex)" Value="item.FreedomExpressionIndex" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.FreedomScore)" Value="item.FreedomScore" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.CensorshipIndex)" Value="item.CensorshipIndex" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.HappinessIndex)" Value="item.HappinessIndex" ShowLabel="false"></ItemData>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Economy</MudText>

                        <ItemData For="@(() => emptyRegion.OECD)" Value="item.OECD" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.GDP_PPP)" Value="item.GDP_PPP" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.GDP_Nominal)" Value="item.GDP_Nominal" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.EconomicFreedomIndex)" Value="item.EconomicFreedomIndex" ShowLabel="true"></ItemData>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Security and Peace</MudText>

                        <ItemData For="@(() => emptyRegion.TsaSafetyIndex)" Value="item.TsaSafetyIndex" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.NumbeoSafetyIndex)" Value="item.NumbeoSafetyIndex" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.GlobalTerrorismIndex)" Value="item.GlobalTerrorismIndex" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.GlobalPeaceIndex)" Value="item.GlobalPeaceIndex" ShowLabel="true"></ItemData>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Environment and Health</MudText>

                        <ItemData For="@(() => emptyRegion.YaleWaterScore)" Value="item.YaleWaterScore" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.NumbeoPollutionIndex)" Value="item.NumbeoPollutionIndex" ShowLabel="true"></ItemData>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Mobility and Tourism</MudText>

                        <ItemData For="@(() => emptyRegion.VisaFree)" Value="item.CalculatePassportIndex()" ShowLabel="true"></ItemData>
                        <ItemData For="@(() => emptyRegion.TourismIndex)" Value="item.TourismIndex" ShowLabel="true"></ItemData>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Guide</MudText>

                        <ItemData For="@(() => item.ConflictLevel)" Value="item.ConflictLevel" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.ConflictForecast)" Value="item.ConflictForecast" ShowLabel="false"></ItemData>
                        <ItemIcon For="@(() => item.Risks!.TransportTaxis)" Icon="@IconsFA.Solid.Icon("taxi").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.TransportTaxis)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.Pickpockets)" Icon="@IconsFA.Solid.Icon("wallet").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.Pickpockets)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.NaturalDisasters)" Icon="@IconsFA.Solid.Icon("fire").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.NaturalDisasters)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.Mugging)" Icon="@IconsFA.Solid.Icon("people-robbery").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.Mugging)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.Terrorism)" Icon="@IconsFA.Solid.Icon("person-rifle").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.Terrorism)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.Scams)" Icon="@IconsFA.Solid.Icon("user-ninja").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.Scams)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.WomenTravelers)" Icon="@IconsFA.Solid.Icon("person-dress").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.WomenTravelers)"></ItemIcon>
                        <ItemIcon For="@(() => item.Risks!.TapWater)" Icon="@IconsFA.Solid.Icon("droplet").WithSize(IconSize.sm).Font" Color="GetColorRisk(item.Risks?.TapWater)"></ItemIcon>
                        <ItemsData For="@(() => item.TaxiApps)" Values="item.TaxiApps" ShowLabel="false" OnlyIcon="true"></ItemsData>
                        <ItemsData For="@(() => item.Languages)" Values="item.Languages" ShowLabel="false" OnlyText="true"></ItemsData>

                        <MudText Color="Color.Secondary" Typo="Typo.subtitle2" Align="Align.Center" Class="my-1">Cost of Living</MudText>

                        <ItemData For="@(() => item.AptCityCenter)" Value="item.AptCityCenter?.Avg" Score="item.AptCityCenter?.Score" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.AptOutsideCenter)" Value="item.AptOutsideCenter?.Avg" Score="item.AptOutsideCenter?.Score" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.Meal)" Value="item.Meal?.Avg" Score="item.Meal?.Score" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.MarketWestern)" Value="@(item.MarketWestern?.Avg * 31)" Score="item.MarketWestern?.Score" ShowLabel="false"></ItemData>
                        <ItemData For="@(() => item.MarketAsian)" Value="@(item.MarketAsian?.Avg * 31)" Score="item.MarketAsian?.Score" ShowLabel="false"></ItemData>
                    </MudPaper>
                }
            </NewRenderControl>
        </MudStack>
    </BodyFragment>
</NewPageSection>


@code {
    private string? continent;
    private string? _selectedRegion;

    private AllRegions? AllRegions { get; set; }

    public ComponentActions<List<RegionData>> Actions { get; set; } = new();
    private List<RegionData> SelectedRegions { get; set; } = [];
    private readonly RegionData emptyRegion = new();

    protected override async Task ProcessInitialData()
    {
        AllRegions = await AllRegionsApi.GetAll();
    }

    private async Task AddHandle()
    {
        Actions.StartLoading?.Invoke(null);
        var data = await RegionsApi.GetRegion(_selectedRegion!.ToString()!.ToLower());
        if (data != null) SelectedRegions.Add(data);
        _selectedRegion = null;
        await InvokeAsync(StateHasChanged);
        Actions.FinishLoading?.Invoke(SelectedRegions);
    }

    public Color GetColorRisk(Level? level)
    {
        if (level == Level.Low) return Color.Success;
        else if (level == Level.Medium) return Color.Warning;
        else if (level == Level.High) return Color.Error;
        else return Color.Default;
    }
}
