@using NS.WEB.Modules.Subscription.Core
@inherits ComponentCore<SettingsPopup>

@inject IpInfoApi IpInfoApi

<MudDialog Style="width: 100%">
    <DialogContent>
        <MudGrid Spacing="@Css.SpaceMedium">
            <MudItem xs="12">
                <MudSelect Value="@Language" ValueChanged="@((AppLanguage vl) => AppLanguageValueChanged(vl))" Label="@GlobalTranslations.AppLanguage"
                           HelperText="@GlobalTranslations.AppLanguageDesc" FullWidth="true">
                    @foreach (var item in appLanguages.OrderBy(p => p.GetName()))
                    {
                        <MudSelectItem Value="@item">@item.GetName()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudText Class="mb-1" Style="font-size: 14px;">Temperature Scale</MudText>
                <MudToggleGroup Value="Temperature" ValueChanged="(Temperature vl) => TemperatureChanged(vl)" SelectionMode="SelectionMode.SingleSelection"
                                Vertical="false" Color="Color.Primary">
                    <MudToggleItem Value="Temperature.Celsius">
                        @Temperature.Celsius.GetName()
                    </MudToggleItem>
                    <MudToggleItem Value="Temperature.Fahrenheit">
                        @Temperature.Fahrenheit.GetName()
                    </MudToggleItem>
                </MudToggleGroup>
            </MudItem>
            <MudItem xs="12">
                <MudText Class="mb-1" Style="font-size: 14px;">App Theme</MudText>
                <MudToggleGroup Value="DarkMode" ValueChanged="(bool vl) => DarkModeChanged(vl)" SelectionMode="SelectionMode.SingleSelection"
                                Vertical="false" Color="Color.Primary">
                    <MudToggleItem Value="false">
                        <MudIcon Icon="@IconsFA.Solid.Icon("sun").Font" Title="@GlobalTranslations.LightMode" Class="me-1"></MudIcon>
                        @GlobalTranslations.LightMode
                    </MudToggleItem>
                    <MudToggleItem Value="true">
                        <MudIcon Icon="@IconsFA.Solid.Icon("moon").Font" Title="@GlobalTranslations.DarkMode" Class="me-1"></MudIcon>
                        @GlobalTranslations.DarkMode
                    </MudToggleItem>
                </MudToggleGroup>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(async () => { await JsRuntime.Utils().ShowCache(); })">
            @Button.ShowCache
        </MudButton>
        @* <MudButton OnClick="@(async () => { await JavascriptVoidAsync("clearLocalStorage"); Navigation.NavigateTo("/", true); })">@Button.ClearCache</MudButton> *@
        <MudSpacer></MudSpacer>
        <MudButton OnClick="@(() => { MudDialog?.Close(); })">
            @Button.Close
        </MudButton>
    </DialogActions>
</MudDialog>

@code {

    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    private readonly AppLanguage[] appLanguages = Enum.GetValues<AppLanguage>();

    public AppLanguage Language { get; set; } = AppLanguage.en;
    public bool DarkMode { get; set; } = false;
    public Temperature Temperature { get; set; } = Temperature.Celsius;

    protected override async Task ProcessInitialData()
    {
        Language = await AppStateStatic.GetAppLanguage(JsRuntime);
        DarkMode = await AppStateStatic.GetDarkMode(JsRuntime) ?? false;
        Temperature = await AppStateStatic.GetTemperature(JsRuntime) ?? Temperature.Celsius;
    }

    protected async Task AppLanguageValueChanged(AppLanguage value)
    {
        Language = value;

        await JsRuntime.Utils().SetStorage("app-language", value);

        Navigation.NavigateTo(Navigation.GetUriWithQueryParameter("app-language", value.ToString()?.ToLower()), true);
    }

    protected async Task DarkModeChanged(bool value)
    {
        DarkMode = value;

        await JsRuntime.Utils().SetStorage("dark-mode", value);

        AppStateStatic.ChangeDarkMode(value);
    }

    protected async Task TemperatureChanged(Temperature value)
    {
        Temperature = value;

        await JsRuntime.Utils().SetStorage("temperature", value);

        AppStateStatic.ChangeTemperature(value);
    }

}
