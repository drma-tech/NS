@using NS.WEB.Modules.Subscription.Core
@inherits ComponentCore<GoogleAdSense>

@inject PaymentConfigurationApi ConfigurationApi
@inject IpInfoApi IpInfoApi
@inject IpInfoServerApi IpInfoServerApi

@if (!Printscreen && !ActiveSubscription && !IsLocalhost)
{
    <div style="text-align: center;">
        <MudLink Typo="Typo.caption" OnClick="OpenSubscription" Color="Color.Secondary">Remove Advertising</MudLink>
    </div>
    <div id="@_containerId" @key="@_containerId" style="text-align: center;" class="@Css.Build().Large("mb")"></div>
}

@code {
    [CascadingParameter] public AuthPrincipal? Principal { get; set; }

    [Parameter][SupplyParameterFromQuery(Name = "printscreen")] public bool Printscreen { get; set; } = false;
    [Parameter][EditorRequired] public AdUnit Section { get; set; } = AdUnit.Index;

    private bool IsMobile => AppStateStatic.BrowserWindowSize?.Width <= 600 || AppStateStatic.BrowserWindowSize?.Height <= 600;
    private bool IsLocalhost => Navigation.BaseUri.Contains("localhost") || Navigation.BaseUri.Contains("dev");
    private bool ActiveSubscription => Principal?.GetActiveSubscription() != null;

    private const string AdClientId = "5145928155833172";
    private readonly string _containerId = $"ad-container-{Guid.NewGuid()}";

    private readonly Dictionary<string, string> _BlockedCountries = new()
    {
        { "CU", "Cuba" },
        { "IR", "Iran" },
        { "KP", "North Korea" },
        { "CN", "China (Mainland)" }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender && !IsLocalhost && !ActiveSubscription)
            {
                var country = await AppStateStatic.GetCountry(IpInfoApi, IpInfoServerApi, JsRuntime);

                if (country == "CN")
                {
                    //todo: implement https://www.baiduadvertising.com/
                }
                else if (country.Empty() || _BlockedCountries.ContainsKey(country))
                {
                    //do not show ads
                }
                else
                {
                    await JsRuntime.Services().InitAdSense($"ca-pub-{AdClientId}", Section, _containerId);
                }
            }
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }

    private async Task OpenSubscription()
    {
        await DialogService.SubscriptionPopup();
    }

    public enum AdUnit : long
    {
        Index = 2276709621,
        Index2 = 5449765937,
        Profile = 8786277653,
        Explore = 3889272251,
        Explore2 = 2535837722,
        Explore3 = 6846608081,
        Suggestion = 9664343113,
        Tools = 1650121727,
    }
}
